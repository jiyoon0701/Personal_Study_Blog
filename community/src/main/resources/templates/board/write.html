<!DOCTYPE html>
<html lang="UTF-8">
<head>
    <!-- Toast UI Editor -->
    <meta charset="utf-8" />
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
</head>
<body>
<h1 style="text-align:center"><input type = "text" placeholder=" 제목을 입력해주세요" id = "TITLE"></h1>
<div id="editor"></div>
<form id = "save">
    <input type="file" id = "files"name = "files" multiple = "multiple" class="pre">
    <button type="button" id = "saveBtn">저장하기</button>
</form>

<button onclick="seeHtml()">html보기</button>]
<button onclick="seeMd()">markdown보기</button>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script>
    $(function(){

        $('#saveBtn').on('click', function(){
            save();
        });

    });
    function imageUpload(formData) {
        let imageURL;

        $.ajax({
            type: "POST",
            url: "/board/imageupload",
            async: false,
            data: formData,
            async : false,
            processData: false,
            contentType: false,
            success: function (data) {
                imageURL = data;
                console.log(imageURL);

            },
            error: function (request, status, error) {
                alert(request + ", " + status + ", " + error);
            },

        });

        return imageURL;
    }
    const Editor = toastui.Editor;

    const editor = new Editor({
        el: document.querySelector('#editor'),
        height: '600px',
        initialEditType: 'markdown',
        previewStyle: 'vertical',
        hooks : {
            addImageBlobHook: function (blob, callback) {
                const formData = new FormData();
                formData.append("image", blob);
                formData.append("uri", window.location.pathname);
                const imageURL = imageUpload(formData);
                callback(imageURL, "image");
            },
        }
    });

    function callback(files, callbacks){ // 파일 이름 컴온
        const formData = new FormData();

        console.log(files)
        formData.append("uri", window.location.pathname);
        formData.append("image", files);
        const imageUrl = imageUpload(formData);
        callbacks(imageUrl);

    }
    function imageUrl(imageURL){
        const imageUrlSplit = imageURL.split('/');
        const fileName = imageUrlSplit[3];

        $.ajax({
                 type: "POST",
                 url: "/board/save",
                 data: {
                     TITLE : $("#TITLE").val(),
                     content_HTML : editor.getHTML().toString(),
                     content_MARK : editor.getMarkdown().toString(),
                     file_NAME : fileName.toString(),
                 },
                async: false,
                 success: function (data) {
                       alert("등록 완료")
                      window.location.href = "/board/view";
                 },
                 error: function (request, status, error) {
                     alert(request + ", " + status + ", " + error);
                 },
             });
    }

    function save(){
        const files = document.querySelector(".pre").files[0];
        console.log(files)
        callback(files, imageUrl);
    }


        // const title = $("#TITLE").val();
        //  const formData = new FormData();
        //  const files = document.querySelector('input[type="file"]').files[0];
        //  console.log(files)
        //  formData.append("uri", window.location.pathname);
        //  formData.append("image", files);
        // const imageURL = imageUpload(formData);
        //     const imageUrlSplit = imageURL.split('/');
        //     const fileName = imageUrlSplit[3];
        // $.ajax({
        //     type: "POST",
        //     url: "/board/save",
        //     data: {
        //         TITLE : $("#TITLE").val(),
        //         content_HTML : editor.getHTML().toString(),
        //         content_MARK : editor.getMarkdown().toString(),
        //         file_NAME : fileName.toString(),
        //     },
        //     success: function (data) {
        //           alert("등록 완료")
        //          window.location.href = "/board/view";
        //     },
        //     error: function (request, status, error) {
        //         alert(request + ", " + status + ", " + error);
        //     },
        // });

    seeHtml = function(){
        alert(editor.getHTML());
    }
    seeMd = function(){
        alert(editor.getMarkdown());
    }
</script>
</body>